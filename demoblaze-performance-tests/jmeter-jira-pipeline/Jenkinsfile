pipeline {
    agent any

    environment {
        JMETER_BIN   = 'C:\\Users\\Admin\\Desktop\\Tools\\JMeter\\apache-jmeter-5.6.3\\apache-jmeter-5.6.3\\bin\\jmeter.bat'
        JMX_FILE     = 'jmeter-jira-pipeline\\Demoblaze_Jenkins_Pipeline.jmx'
        RESULTS_DIR  = 'results'
        RESULTS_FILE = 'results\\results.jtl'
        REPORT_DIR   = 'html-report'
        JIRA_URL     = 'https://meeraraju2711.atlassian.net'
        JIRA_EMAIL   = 'meeraraju2711@gmail.com'
        JIRA_PROJECT = 'KAN'
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/meeraraju27/demoblaze-performance-tests.git'
            }
        }

        stage('Run JMeter Stress Test') {
            steps {
                bat """
                    if not exist results mkdir results
                    if exist html-report rmdir /s /q html-report
                    call "%JMETER_BIN%" -n -t "jmeter-jira-pipeline\\Demoblaze_Jenkins_Pipeline.jmx" -l "results\\results.jtl" -e -o "html-report"
                """
            }
        }

        stage('Publish HTML Report') {
            steps {
                publishHTML(target: [
                    allowMissing         : false,
                    alwaysLinkToLastBuild: true,
                    keepAll              : true,
                    reportDir            : 'html-report',
                    reportFiles          : 'index.html',
                    reportName           : 'JMeter Stress Test Report'
                ])
            }
        }

        stage('Check Results & Create Jira Ticket') {
            steps {
                script {
                    def failCount = bat(
                        script: '@findstr /c:"false," "results\\results.jtl"',
                        returnStdout: true
                    ).trim().readLines().size()

                    echo "Failed samples: ${failCount}"

                    if (failCount > 0) {
                        echo "Failures found! Creating Jira ticket..."
                        withCredentials([string(credentialsId: 'JIRA_API_TOKEN', variable: 'JIRA_TOKEN')]) {
                            bat """
                                curl -s -X POST ^
                                -H "Content-Type: application/json" ^
                                -u "%JIRA_EMAIL%:%JIRA_TOKEN%" ^
                                --data "{\"fields\":{\"project\":{\"key\":\"%JIRA_PROJECT%\"},\"summary\":\"Jenkins - Stress Test Failed (%failCount% samples)\",\"description\":\"Automated failure detected by Jenkins.\\\\nFailed Samples: %failCount%\\\\nBuild: %BUILD_NUMBER%\\\\nURL: %BUILD_URL%\",\"issuetype\":{\"name\":\"Bug\"}}}" ^
                                %JIRA_URL%/rest/api/2/issue
                            """
                        }
                    } else {
                        echo "All tests passed! No Jira ticket needed."
                    }
                }
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully!"
        }
        failure {
            echo "Pipeline failed! Check the console output."
        }
        always {
            echo "Build ${BUILD_NUMBER} finished."
        }
    }
}
