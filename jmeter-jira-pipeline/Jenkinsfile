pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/meeraraju27/demoblaze-performance-tests.git'
            }
        }

        stage('Run JMeter Stress Test') {
            steps {
                bat '''
                    REM FULL CLEAN
                    if exist results rmdir /s /q results
                    if exist html-report rmdir /s /q html-report
                    
                    mkdir results
                    mkdir html-report
                    
                    REM Run JMeter DIRECTLY to workspace dirs
                    "C:\\Users\\Admin\\Desktop\\Tools\\JMeter\\apache-jmeter-5.6.3\\apache-jmeter-5.6.3\\bin\\jmeter.bat" -n ^
                        -t "jmeter-jira-pipeline\\Demoblaze_Jenkins_Pipeline.jmx" ^
                        -l "results\\results.jtl" ^
                        -e -o "html-report"
                '''
            }
        }

        stage('Publish HTML Report') {
            steps {
                publishHTML([
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'html-report',
                    reportFiles: 'index.html',
                    reportName: 'Demoblaze Performance Report'
                ])
            }
        }

        stage('Create Jira Ticket') {
            steps {
                script {
                    def resultsFile = 'results/results.jtl'
                    if (fileExists(resultsFile)) {
                        def content = readFile(resultsFile)
                        def failCount = (content =~ /(?s).*?false,.*?/).size()
                        if (failCount > 0) {
                            writeFile file: 'jira.json', text: """
{
  "fields": {
    "project": { "key": "KAN" },
    "summary": "Demoblaze Perf FAIL - ${failCount} errors", 
    "description": "Build ${BUILD_NUMBER}\\n${BUILD_URL}",
    "issuetype": { "name": "Bug" }
  }
}
"""
                            withCredentials([string(credentialsId: 'JIRA_API_TOKEN', variable: 'JIRA_TOKEN')]) {
                                bat 'curl -s -X POST -H "Content-Type: application/json" -u "meeraraju2711@gmail.com:%JIRA_TOKEN%" --data @jira.json "https://meeraraju2711.atlassian.net/rest/api/2/issue"'
                            }
                            echo "âœ… Jira ticket created for ${failCount} failures!"
                        } else {
                            echo "âœ… All tests passed - no ticket needed"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'results/**, html-report/**, jira.json', allowEmptyArchive: true
            echo "ðŸŽ‰ Build ${BUILD_NUMBER} COMPLETE!"
            echo "ðŸ“Š Dashboard: Demoblaze Performance Report above"
            echo "ðŸ“¥ Artifacts: results.jtl + html-report/ ready for download"
        }
    }
}
