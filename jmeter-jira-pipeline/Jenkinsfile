pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main',
                    url: 'https://github.com/meeraraju27/demoblaze-performance-tests.git'
            }
        }

        stage('Run JMeter Stress Test') {
            steps {
                bat '''
                    REM Clean previous results
                    if not exist results mkdir results
                    if exist html-report rmdir /s /q html-report
                    
                    REM Go to JMeter bin and run directly
                    cd /d "C:\\Users\\Admin\\Desktop\\Tools\\JMeter\\apache-jmeter-5.6.3\\apache-jmeter-5.6.3\\bin"
                    
                    REM Full workspace paths - adjust if workspace path differs
                    jmeter -n ^
                        -t "C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\Demoblaze-Performance-Pipeline\\jmeter-jira-pipeline\\Demoblaze_Jenkins_Pipeline.jmx" ^
                        -l "C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\Demoblaze-Performance-Pipeline\\results\\results.jtl" ^
                        -e -o "C:\\ProgramData\\Jenkins\\.jenkins\\workspace\\Demoblaze-Performance-Pipeline\\html-report"
                '''
            }
        }

        stage('Publish HTML Report') {
            steps {
                publishHTML([
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: 'html-report',
                    reportFiles: 'index.html',
                    reportName: 'JMeter Report'
                ])
            }
        }

        stage('Jira Automation') {
            steps {
                script {
                    def resultsFile = 'results\\results.jtl'
                    def failCount = 0
                    
                    if (fileExists(resultsFile)) {
                        def results = readFile(resultsFile)
                        failCount = (results =~ /(?s).*?false,.*?/).size()
                    }
                    
                    echo "Failed requests: ${failCount}"
                    
                    if (failCount > 0) {
                        echo "Creating Jira ticket for ${failCount} failures"
                        withCredentials([string(credentialsId: 'JIRA_API_TOKEN', variable: 'JIRA_TOKEN')]) {
                            bat """
                                curl -X POST ^
                                -H "Authorization: Basic %JIRA_EMAIL%:%JIRA_TOKEN%" ^
                                -H "Content-Type: application/json" ^
                                -d "{\"fields\":{\"project\":{\"key\":\"KAN\"},\"summary\":\"Performance Test Failed - ${failCount} errors\",\"description\":\"JMeter test failed in build %BUILD_NUMBER%. Check: %BUILD_URL%\",\"issuetype\":{\"name\":\"Bug\"}}}" ^
                                https://meeraraju2711.atlassian.net/rest/api/2/issue
                            """
                        }
                    } else {
                        echo " All tests passed!"
                    }
                }
            }
        }
    }

    post {
        always {
            echo "Build ${BUILD_NUMBER} complete."
            archiveArtifacts artifacts: 'results/**, html-report/**', allowEmptyArchive: true
        }
        failure {
            echo "Check console above."
        }
    }
}